<style>/* 
   Some simple Github-like styles, with syntax highlighting CSS via Pygments.
*/
html {
	background:#fff;
	margin:0;
	padding:0;
}
body {
	font: 14px helvetica,arial,freesans,clean,sans-serif;
	line-height: 1.6;
	margin: 0 auto;
  padding: 20px;
	text-align:left;
	color: #333;
	width:920px;
}

.md {
	background-color: #eee;
	border-radius:3px;
  margin: 0;
	padding:3px;
}

article {
  padding: 30px;
  border: 1px solid #cacaca;
  background-color: white;
}
article > :first-child {
  margin-top: 0!important;
}

h1 {
	font-size:28px;
	margin-bottom:10px;
  color: black;
}

h2 {
	font-size:24px;
	margin:20px 0 10px;
  color: black;
  border-bottom: 1px solid #ccc;
}

h3 {
	font-size:18px;
	margin:20px 0 10px;
}

h4 {
	font-size:16px;
	font-weight:bold;
	margin:20px 0 10px;
}

h5 {
	font-size:14px;
	font-weight:bold;
	margin:20px 0 10px;
}

h6 {
	color:#777;
	font-size:14px;
	font-weight:bold;
	margin:20px 0 10px;
}

hr {
	background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
	border: 0 none;
	height: 4px;
	margin: 15px 0;
	padding: 0;
}


p {
	margin: 15px 0; 
}

pre, code {
	font: 12px 'Bitstream Vera Sans Mono','Courier',monospace;
}
.highlight pre, pre {
	background-color:#f8f8f8;
	border:1px solid #ccc;
	font-size:13px;
	line-height:19px;
	overflow:auto;
	border-radius:3px;
	-moz-border-radius:3px;
	-webkit-border-radius:3px;
	padding:6px 10px;
}



code {
	white-space:nowrap;
	border:1px solid #eaeaea;
	background-color:#f8f8f8;
	border-radius:3px;
	-moz-border-radius:3px;
	-webkit-border-radius:3px;
	margin:0 2px;
	padding:0 5px;
}

pre>code
{
	white-space:pre;
	border:none;
	background:transparent;
	margin:0;
	padding:0;
}

a, a code {
	color: #4183C4;
	text-decoration:none;
}


blockquote
{
	border-left:4px solid #ddd;
	padding-left:11px;
	color:#555;
	margin:14px 0;
}

table
{
  font-size: 14px;
	border-collapse:collapse;
	margin:20px 0 0;
	padding:0;
}

table tr
{
	border-top:1px solid #ccc;
	background-color:#fff;
	margin:0;
	padding:0;
}

table tr:nth-child(2n)
{
	background-color:#f8f8f8;
}
table tr th[align="center"], table tr td[align="center"] {
	text-align:center;
}
table tr th, table tr td
{
	border:1px solid #ccc;
	text-align:left;
	margin:0;
	padding:6px 13px;
}

ul, ol
{
	margin:15px 0;
}

ul li, ol li
{
	margin-top:7px;
	margin-bottom:7px;
}



.shadow {
	-webkit-box-shadow:0 5px 15px #000;
	-moz-box-shadow:0 5px 15px #000;
	box-shadow:0 5px 15px #000;		
}



/* Pygments coloring */
.highlight .c{color:#998;font-style:italic;}
.highlight .err{color:#a61717;background-color:#e3d2d2;}
.highlight .k{font-weight:bold;}
.highlight .o{font-weight:bold;}
.highlight .cm{color:#998;font-style:italic;}
.highlight .cp{color:#999;font-weight:bold;}
.highlight .c1{color:#998;font-style:italic;}
.highlight .cs{color:#999;font-weight:bold;font-style:italic;}
.highlight .gd{color:#000;background-color:#fdd;}
.highlight .gd .x{color:#000;background-color:#faa;}
.highlight .ge{font-style:italic;}
.highlight .gr{color:#a00;}
.highlight .gh{color:#999;}
.highlight .gi{color:#000;background-color:#dfd;}
.highlight .gi .x{color:#000;background-color:#afa;}
.highlight .go{color:#888;}
.highlight .gp{color:#555;}
.highlight .gs{font-weight:bold;}
.highlight .gu{color:#800080;font-weight:bold;}
.highlight .gt{color:#a00;}
.highlight .kc{font-weight:bold;}
.highlight .kd{font-weight:bold;}
.highlight .kn{font-weight:bold;}
.highlight .kp{font-weight:bold;}
.highlight .kr{font-weight:bold;}
.highlight .kt{color:#458;font-weight:bold;}
.highlight .m{color:#099;}
.highlight .s{color:#d14;}
.highlight .na{color:#008080;}
.highlight .nb{color:#0086B3;}
.highlight .nc{color:#458;font-weight:bold;}
.highlight .no{color:#008080;}
.highlight .ni{color:#800080;}
.highlight .ne{color:#900;font-weight:bold;}
.highlight .nf{color:#900;font-weight:bold;}
.highlight .nn{color:#555;}
.highlight .nt{color:#000080;}
.highlight .nv{color:#008080;}
.highlight .ow{font-weight:bold;}
.highlight .w{color:#bbb;}
.highlight .mf{color:#099;}
.highlight .mh{color:#099;}
.highlight .mi{color:#099;}
.highlight .mo{color:#099;}
.highlight .sb{color:#d14;}
.highlight .sc{color:#d14;}
.highlight .sd{color:#d14;}
.highlight .s2{color:#d14;}
.highlight .se{color:#d14;}
.highlight .sh{color:#d14;}
.highlight .si{color:#d14;}
.highlight .sx{color:#d14;}
.highlight .sr{color:#009926;}
.highlight .s1{color:#d14;}
.highlight .ss{color:#990073;}
.highlight .bp{color:#999;}
.highlight .vc{color:#008080;}
.highlight .vg{color:#008080;}
.highlight .vi{color:#008080;}
.highlight .il{color:#099;}

</style><div class="md"><article>
<h1>HeroSpaces Client</h1>

<p>This is the HeroSpaces client library in JavaScript. You can use it to
interact with the HeroSpaces.com website at <a href="http://www.herospaces.com">http://www.herospaces.com</a> or
with any compatible web service.</p>
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Library</span> <span class="nx">name</span> <span class="nx">and</span> <span class="nx">version</span><span class="o">&gt;&gt;=</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;HeroClient&#39;</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s1">&#39;0.2.1&#39;</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<h2>Utility methods</h2>

<p>We need various functionality to support our library that isn&#39;t offered
in plain JavaScript. Instead of importing bulky libraries we create a
few lightweight functions by hand.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Utility</span> <span class="nx">methods</span><span class="o">&gt;&gt;=</span>

<span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">doRequest</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">join</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">async</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">array</span> <span class="nx">handling</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">max</span><span class="o">&gt;&gt;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>Utility: doRequest</h3>

<p>If we can make our code runnable both in a browser and inside Node.js
then that increases its value a lot. So let&#39;s abstract away the details
of making a HTTP request in a function <code>doRequest</code> that tries to use an
<code>XMLHttpRequest</code> and falls back on node&#39;s <code>http</code> and <code>url</code> modules.
While we&#39;re at it we can handle IE&#39;s <code>ActiveXObject</code> quirkiness.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">doRequest</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">doRequest</span> <span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">useXhr</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">onXHRResponse</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">};</span>
            <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span><span class="err"> </span><span class="nx">code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="nx">async</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">]);</span>
        <span class="p">};</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="cm">/* async: */</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="err"> </span><span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">})();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">useXhr</span><span class="p">(</span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">useXhr</span><span class="p">(</span><span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Msxml2.XMLHTTP&quot;</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">urlM</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">urlM</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">handle</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span><span class="err"> </span><span class="nx">code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="kd">var</span> <span class="nx">resData</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">readData</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resData</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">doCallback</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">async</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resData</span><span class="p">,</span> <span class="nx">res</span><span class="p">]);</span>
            <span class="p">});</span>
        <span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>Utility: join</h3>

<p>We sometimes base path and a file/directory name. Now say we want to
join these together. But sometimes the base path will be falsy. The same
goes for the name. So we only want to add a separator (<code>/</code>) if both are
true-ish. That&#39;s what <code>join</code> does.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">join</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">join</span> <span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sep</span> <span class="o">=</span> <span class="p">(</span><span class="nx">base</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">base</span> <span class="o">+</span> <span class="nx">sep</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">};</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>Utility: async</h3>

<p>We sometimes want to run several callbacks in succession. Instead of
calling each one in turn and waiting for it to return we can also run it
asynchronously. As a nice side effect this will stop any errors from
bubbling up into our code. We simply use <code>setTimeout</code> which works in
Node.js and in the browser.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">async</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">doCall</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">cb</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">doCall</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">};</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>Utility: array handling</h3>

<p>Browsers do not reliably provide a <code>forEach</code> on arrays. So we provide
our own. Note that we shouldn&#39;t modify <code>Array.prototype</code>.</p>

<p>We also provide a <code>map</code> function.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">array</span> <span class="nx">handling</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">forEach</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">cb</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">map</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">forEach</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">};</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>Utility: max</h3>

<p>When dealing with an array or ordered or partially ordered objects that
aren&#39;t <code>Number</code>s we cannot use <code>Math.max</code> but may want to find the
maximum object. For this we can pass in a <code>cmp</code> function that is given
two objects. The output should follow these rules:</p>

<ul>
<li><code>cmp(a, b) &lt; 0</code> iff <code>a &lt; b</code></li>
<li><code>cmp(a, b) &gt; 0</code> iff <code>a &gt; b</code></li>
<li><code>cmp(a, b) == 0</code> otherwise</li>
</ul>

<p>Note that <code>cmp(a, b) == 0</code> does not imply <code>a == b</code>. This accounts for
partially ordered sets.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Utility</span><span class="o">:</span> <span class="nx">max</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">max</span> <span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">cmp</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Need at least one value for max()&quot;</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">forEach</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cmp</span><span class="p">(</span><span class="nx">max</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">max</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">max</span><span class="p">;</span>
<span class="p">};</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h2>File interface</h2>

<p>We define a simple file level interface that you can use to upload and
download files as well as manipulate directories.</p>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">&gt;&gt;=</span>

<span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">get</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">put</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">ls</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">find</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">mkdir</span><span class="o">&gt;&gt;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>File interface: get</h3>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">get</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">get</span> <span class="p">(</span><span class="nx">fileurl</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">doRequest</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">fileurl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="nx">get</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>File interface: put</h3>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">put</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">put</span> <span class="p">(</span><span class="nx">fileurl</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">doRequest</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="nx">fileurl</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">put</span> <span class="o">=</span> <span class="nx">put</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>File interface: ls</h3>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">ls</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">ls</span> <span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">handleContent</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
        <span class="nx">async</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="nx">info</span><span class="p">]);</span>
    <span class="p">};</span>
    <span class="nx">doRequest</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">dirurl</span> <span class="o">+</span> <span class="s1">&#39;?&amp;listing=1&amp;&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">handleContent</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">ls</span> <span class="o">=</span> <span class="nx">ls</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>File interface: find</h3>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">find</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">rawFind</span> <span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">handleLs</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ls</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ls</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">forEach</span><span class="p">(</span><span class="nx">ls</span><span class="p">.</span><span class="nx">files</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">handleFile</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">relName</span> <span class="o">=</span> <span class="nx">join</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
                <span class="nx">async</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="nx">relName</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">]);</span>
            <span class="p">});</span>
        <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">branchCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">handleDone</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">branchCount</span><span class="o">--</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">branchCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">async</span><span class="p">(</span><span class="nx">doneCb</span><span class="p">,</span> <span class="p">[]);</span>
            <span class="p">};</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ls</span><span class="p">.</span><span class="nx">dirs</span> <span class="o">&amp;&amp;</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">dirs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">branchCount</span> <span class="o">+=</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">dirs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="nx">forEach</span><span class="p">(</span><span class="nx">ls</span><span class="p">.</span><span class="nx">dirs</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">handleDir</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">relName</span> <span class="o">=</span> <span class="nx">join</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">dir</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">absName</span> <span class="o">=</span> <span class="nx">join</span><span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="nx">dir</span><span class="p">);</span>
                <span class="nx">async</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="nx">relName</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span><span class="p">]);</span>
                <span class="nx">async</span><span class="p">(</span><span class="nx">rawFind</span><span class="p">,</span> <span class="p">[</span><span class="nx">absName</span><span class="p">,</span> <span class="nx">relName</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">handleDone</span><span class="p">]);</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">branchCount</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">handleDone</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">};</span>
    <span class="nx">ls</span><span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="nx">handleLs</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">find</span> <span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rawFind</span><span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">fullyDone</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">async</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">]);</span>
    <span class="p">});</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="nx">find</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h3>File interface: mkdir</h3>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">:</span> <span class="nx">mkdir</span><span class="o">&gt;&gt;=</span>
<span class="kd">function</span> <span class="nx">mkdir</span> <span class="p">(</span><span class="nx">dirurl</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">doRequest</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">dirurl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">mkdir</span> <span class="o">=</span> <span class="nx">mkdir</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h2>Package repository client</h2>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;</span><span class="nx">Package</span> <span class="nx">repository</span> <span class="nx">client</span><span class="o">&gt;&gt;=</span>
<span class="cm">/* Usage examples:</span>
<span class="cm"> *</span>
<span class="cm"> *     repository.atHeroSpaces(&#39;amber&#39;).package(&#39;foo&#39;).</span>
<span class="cm"> *         version(1, 2, 3).get(&#39;code.js&#39;, function (err, data) { ... });</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">repository</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">packageVersion</span> <span class="p">(</span><span class="kr">package</span><span class="p">,</span> <span class="nx">major</span><span class="p">,</span> <span class="nx">minor</span><span class="p">,</span> <span class="nx">patch</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="kd">var</span> <span class="nx">versionString</span> <span class="o">=</span> <span class="p">[</span><span class="nx">major</span><span class="p">,</span> <span class="nx">minor</span><span class="p">,</span> <span class="nx">patch</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">packageUrl</span> <span class="o">=</span> <span class="kr">package</span><span class="p">.</span><span class="nx">url</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">sep</span> <span class="o">=</span> <span class="p">(</span><span class="nx">packageUrl</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">packageUrl</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">?</span>
            <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">versionUrl</span> <span class="o">=</span> <span class="nx">packageUrl</span> <span class="o">+</span> <span class="nx">sep</span> <span class="o">+</span> <span class="nx">versionString</span><span class="p">;</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">major</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">major</span><span class="p">;</span> <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">minor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">minor</span><span class="p">;</span> <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">patch</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">patch</span><span class="p">;</span> <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">versionUrl</span><span class="p">;</span> <span class="p">};</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">cmp</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">major</span> <span class="o">&lt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">major</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">major</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">major</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span>  <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">minor</span> <span class="o">&lt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">minor</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">minor</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">minor</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span>  <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">patch</span> <span class="o">&lt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">patch</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">patch</span> <span class="o">&gt;</span> <span class="nx">other</span><span class="p">.</span><span class="nx">patch</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span>  <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mkdir</span><span class="p">(</span><span class="nx">versionUrl</span> <span class="o">+</span> <span class="s1">&#39;?&amp;init=1&amp;&#39;</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">freeze</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">freezeOptions</span> <span class="o">=</span> <span class="p">{</span><span class="nx">keys</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">get</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">put</span><span class="o">:</span> <span class="p">[],</span> <span class="c1">// No PUT e.g. on _options.</span>
                <span class="nx">ls</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">admin</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// Allow reads of _options. PUT disabled above.</span>
                <span class="nx">mkdir</span><span class="o">:</span> <span class="p">[]</span>
            <span class="p">}};</span>
            <span class="kd">var</span> <span class="nx">freezeString</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">freezeOptions</span><span class="p">);</span>
            <span class="nx">put</span><span class="p">(</span><span class="nx">versionUrl</span> <span class="o">+</span> <span class="s1">&#39;/_options&#39;</span><span class="p">,</span> <span class="nx">freezeString</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">put</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">put</span><span class="p">(</span><span class="nx">versionUrl</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">get</span><span class="p">(</span><span class="nx">versionUrl</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="kr">package</span> <span class="p">(</span><span class="nx">repository</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="kd">var</span> <span class="nx">repoRoot</span> <span class="o">=</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">url</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">sep</span> <span class="o">=</span> <span class="p">(</span><span class="nx">repoRoot</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">repoRoot</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">packageUrl</span> <span class="o">=</span> <span class="nx">repoRoot</span> <span class="o">+</span> <span class="nx">sep</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">versionFromString</span> <span class="p">(</span><span class="nx">versionString</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">versionString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;A version should have three parts&quot;</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="kd">var</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">major</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">minor</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">patch</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="k">return</span> <span class="nx">packageVersion</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">major</span><span class="p">,</span> <span class="nx">minor</span><span class="p">,</span> <span class="nx">patch</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">packageUrl</span><span class="p">;</span> <span class="p">};</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">major</span><span class="p">,</span> <span class="nx">minor</span><span class="p">,</span> <span class="nx">patch</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">packageVersion</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">major</span><span class="p">,</span> <span class="nx">minor</span><span class="p">,</span> <span class="nx">patch</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mkdir</span><span class="p">(</span><span class="nx">packageUrl</span> <span class="o">+</span> <span class="s1">&#39;?&amp;init=1&amp;&#39;</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">allVersions</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ls</span><span class="p">(</span><span class="nx">packageUrl</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">handleInfo</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">};</span>
                <span class="kd">var</span> <span class="nx">versionStrings</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">dirs</span> <span class="o">||</span> <span class="p">[];</span>
                <span class="kd">var</span> <span class="nx">versions</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">versionStrings</span><span class="p">,</span> <span class="nx">versionFromString</span><span class="p">);</span>
                <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">versions</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">latestVersion</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">allVersions</span><span class="p">(</span><span class="kd">function</span> <span class="nx">handleVersions</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">versions</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">};</span>
                <span class="kd">var</span> <span class="nx">maxVersion</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">versions</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">cmp</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cmp</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">maxVersion</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">repository</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">url</span><span class="p">;</span> <span class="p">};</span>

        <span class="nx">that</span><span class="p">.</span><span class="kr">package</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kr">package</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">repositoryFactory</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">atUrl</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">repository</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">atHeroSpaces</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">area</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">repository</span><span class="p">(</span><span class="s1">&#39;http://www.herospaces.com/repo/&#39;</span> <span class="o">+</span> <span class="nx">area</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">atHeroSpace</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">atHeroSpaces</span><span class="p">;</span> <span class="c1">// Backwards-compatibility.</span>

        <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">repositoryFactory</span><span class="p">();</span>
<span class="p">})();</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">repository</span> <span class="o">=</span> <span class="nx">repository</span><span class="p">;</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<h2>Module definition</h2>

<!-- {{{ -->
<div class="highlight"><pre><span class="o">&lt;&lt;*&gt;&gt;=</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">();</span> <span class="c1">// CommonJS</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="nx">factory</span><span class="p">);</span> <span class="c1">// AMD (RequireJS and family)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">HeroClient</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">();</span> <span class="c1">// Browser &lt;script&gt;</span>
  <span class="p">}</span>
<span class="p">}(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">exports</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="o">&lt;&lt;</span><span class="nx">Library</span> <span class="nx">name</span> <span class="nx">and</span> <span class="nx">version</span><span class="o">&gt;&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nx">Utility</span> <span class="nx">methods</span><span class="o">&gt;&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nx">File</span> <span class="kr">interface</span><span class="o">&gt;&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nx">Package</span> <span class="nx">repository</span> <span class="nx">client</span><span class="o">&gt;&gt;</span>

    <span class="k">return</span> <span class="nx">exports</span><span class="p">;</span>
<span class="p">})));</span>
<span class="err">@</span>
</pre></div>
<!-- }}} -->

<!--
vim600: sw=4 ts=4 fdm=marker
vim<600: sw=4 ts=4
-->
</article></div>
